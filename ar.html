<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>è±†ã¾ãARï¼ˆãƒãƒ¼ã‚«ãƒ¼ç‰ˆï¼‰</title>
  <style>
    *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    html,body{ margin:0; height:100%; overflow:hidden; background:#000; }
    #ui{
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      color:#fff; font-weight:900; font-size:40px;
      text-shadow: 3px 3px 0 #000, -3px 3px 0 #000, 3px -3px 0 #000, -3px -3px 0 #000;
      z-index: 9999; pointer-events:none;
    }
    #congrats{
      position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(.6);
      color:#ffe600; font-weight:900; font-size:34px; opacity:0;
      text-shadow: 3px 3px 0 #000, -3px 3px 0 #000, 3px -3px 0 #000, -3px -3px 0 #000;
      z-index: 10000; pointer-events:none;
    }
    #congrats.show{
      animation: pop .8s ease-out forwards;
    }
    @keyframes pop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.6);}
      40%{opacity:1; transform:translate(-50%,-50%) scale(1.2);}
      100%{opacity:1; transform:translate(-50%,-50%) scale(1);}
    }
    #hint{
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
      color: rgba(255,255,255,.9); font-size: 14px; z-index: 9999;
      text-shadow: 2px 2px 0 #000;
      pointer-events:none;
      text-align:center;
      line-height:1.35;
      width: 92vw;
      max-width: 520px;
    }
  </style>

  <!-- A-Frame + AR.jsï¼ˆCDNï¼‰ -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body>
  <div id="ui">0</div>
  <div id="congrats">ğŸ‰ Congratulations!! ğŸ‰</div>
  <div id="hint">ç´™ã«ã€ŒHiroãƒãƒ¼ã‚«ãƒ¼ã€ã‚’è¡¨ç¤º/å°åˆ·ã—ã¦æœºã«ç½®ã„ã¦ã­ã€‚é¬¼ã‚’ã‚¿ãƒƒãƒ—ã§ãƒ’ãƒƒãƒˆï¼ˆé•·æŠ¼ã—é€£å°„ã‚‚å¯¾å¿œï¼‰ã€‚</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true;"
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <a-assets>
      <img id="oniIdle" src="assets/oni_idle.png" />
      <img id="oniHurt" src="assets/oni_hurt.png" />
    </a-assets>

    <!-- ã‚¿ãƒƒãƒ—åˆ¤å®šç”¨ï¼šç”»é¢ã‚¿ãƒƒãƒ—ã‚’ãƒ¬ã‚¤ã«ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›OKï¼‰ -->
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>

    <!-- Hiroãƒãƒ¼ã‚«ãƒ¼ -->
    <a-marker preset="hiro">
      <!-- é¬¼ï¼šæ¿ãƒãƒªã«PNGè²¼ã‚‹ï¼ˆç­‰èº«å¤§æ„Ÿã¯ scale ã§èª¿æ•´ï¼‰ -->
      <a-plane
        id="oniPlane"
        class="clickable"
        src="#oniIdle"
        position="0 0.9 0"
        rotation="-90 0 0"
        width="1.0"
        height="1.5"
        material="transparent: true; alphaTest: 0.1;"
      ></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // ===== è¨­å®š =====
    const HIT_MAX = 9999999;
    const FIRE_INTERVAL = 90;

    // ===== UI =====
    const ui = document.getElementById("ui");
    const congratsEl = document.getElementById("congrats");

    let hitCount = 0;
    let isCongratulated = false;

    // ===== éŸ³ï¼ˆiPhoneå¯¾ç­–ï¼šæœ€åˆã®æ“ä½œã§unlockï¼‰ =====
    const HIT_SOUNDS = Array.from({length: 8}, () => new Audio("assets/hit.mp3"));
    HIT_SOUNDS.forEach(s => { s.preload = "auto"; s.volume = 0.35; });
    let hitIndex = 0;
    let audioUnlocked = false;

    function unlockAudio(){
      if(audioUnlocked) return;
      audioUnlocked = true;
      HIT_SOUNDS.forEach(s=>{
        s.play().then(()=>{ s.pause(); s.currentTime = 0; }).catch(()=>{});
      });
    }

    function playHitSound(){
      const s = HIT_SOUNDS[hitIndex];
      hitIndex = (hitIndex + 1) % HIT_SOUNDS.length;
      s.currentTime = 0;
      s.play().catch(()=>{});
    }

    // ===== é¬¼ã®è¦‹ãŸç›®åˆ‡æ›¿ï¼ˆç¢ºå®Ÿã«æˆ»ã‚‹æ–¹å¼ï¼‰ =====
    const oniPlane = document.getElementById("oniPlane");
    let hurtTimer = null;

    function flashHurt(){
      oniPlane.setAttribute("src", "#oniHurt");
      if(hurtTimer) clearTimeout(hurtTimer);
      hurtTimer = setTimeout(()=>{
        oniPlane.setAttribute("src", "#oniIdle");
        hurtTimer = null;
      }, 140);
    }

    // ===== ãƒ’ãƒƒãƒˆå‡¦ç† =====
    function onHit(){
      unlockAudio();
      playHitSound();
      flashHurt();

      if(hitCount < HIT_MAX){
        hitCount++;
        ui.textContent = hitCount.toLocaleString();
      }

      if(hitCount === HIT_MAX && !isCongratulated){
        isCongratulated = true;
        congratsEl.classList.add("show");
      }
    }

    // ===== ã‚¿ãƒƒãƒ—ã§ãƒ’ãƒƒãƒˆï¼ˆã¾ãšç¢ºå®Ÿã«å‹•ãåŸºæœ¬ï¼‰ =====
    oniPlane.addEventListener("click", onHit);

    // ===== é•·æŠ¼ã—é€£å°„ï¼ˆæŒ‡ã‚’é›¢ã™ã¾ã§ã€é¬¼ã«å½“ãŸã‚Šç¶šã‘ã‚‹ï¼‰ =====
    let isFiring = false;
    let timer = null;

    function startFiring(){
      if(isFiring) return;
      isFiring = true;
      onHit(); // æœ€åˆã®ä¸€ç™º

      timer = setInterval(()=>{
        onHit();
      }, FIRE_INTERVAL);
    }

    function stopFiring(){
      isFiring = false;
      if(timer) clearInterval(timer);
      timer = null;
    }

    // iPhoneã¯ touch ã‚’å„ªå…ˆï¼ˆpassive:false ã§ preventDefault ãŒåŠ¹ãï¼‰
    oniPlane.addEventListener("touchstart", (e)=>{
      e.preventDefault();
      startFiring();
    }, {passive:false});

    document.addEventListener("touchend", stopFiring, {passive:false});
    document.addEventListener("touchcancel", stopFiring, {passive:false});
  </script>
</body>
</html>
